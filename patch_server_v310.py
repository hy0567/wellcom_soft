#!/usr/bin/env python3
"""WellcomSOFT 서버 종합 패치 v3.1.0
실행: sudo python3 ~/patch_server_v310.py && sudo systemctl restart wellcomsoft-api
변경 내역:
  - Admin 초기 비밀번호 무작위 생성
  - 로그인 속도 제한 (Rate Limiting)
  - 오프라인 에이전트 자동 정리
  - relay_managers set 자료구조
  - 하드웨어 필드 (cpu/ram/gpu/motherboard)
  - ip_public, ws_port, agent_version 필드
"""
import base64, shutil, os, sys
from datetime import datetime

SERVER_DIR = "/opt/wellcomsoft-api"
BACKUP_DIR = f"/opt/wellcomsoft-api/backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}"

MODELS_B64 = "IiIiUHlkYW50aWMg66qo6424ICjsmpTssq0v7J2R64u1IOyKpO2CpOuniCkiIiIKZnJvbSB0eXBpbmcgaW1wb3J0IE9wdGlvbmFsLCBMaXN0CmZyb20gcHlkYW50aWMgaW1wb3J0IEJhc2VNb2RlbAoKCiMgPT09IEF1dGggPT09CmNsYXNzIExvZ2luUmVxdWVzdChCYXNlTW9kZWwpOgogICAgdXNlcm5hbWU6IHN0cgogICAgcGFzc3dvcmQ6IHN0cgoKCmNsYXNzIExvZ2luUmVzcG9uc2UoQmFzZU1vZGVsKToKICAgIHRva2VuOiBzdHIKICAgIHVzZXI6ICJVc2VySW5mbyIKCgpjbGFzcyBVc2VySW5mbyhCYXNlTW9kZWwpOgogICAgaWQ6IGludAogICAgdXNlcm5hbWU6IHN0cgogICAgcm9sZTogc3RyCiAgICBkaXNwbGF5X25hbWU6IE9wdGlvbmFsW3N0cl0gPSBOb25lCgoKIyA9PT0gVXNlcnMgPT09CmNsYXNzIFVzZXJDcmVhdGUoQmFzZU1vZGVsKToKICAgIHVzZXJuYW1lOiBzdHIKICAgIHBhc3N3b3JkOiBzdHIKICAgIHJvbGU6IHN0ciA9ICJ1c2VyIgogICAgZGlzcGxheV9uYW1lOiBPcHRpb25hbFtzdHJdID0gTm9uZQoKCmNsYXNzIFVzZXJVcGRhdGUoQmFzZU1vZGVsKToKICAgIGRpc3BsYXlfbmFtZTogT3B0aW9uYWxbc3RyXSA9IE5vbmUKICAgIHJvbGU6IE9wdGlvbmFsW3N0cl0gPSBOb25lCiAgICBpc19hY3RpdmU6IE9wdGlvbmFsW2Jvb2xdID0gTm9uZQogICAgcGFzc3dvcmQ6IE9wdGlvbmFsW3N0cl0gPSBOb25lCgoKY2xhc3MgVXNlclJlc3BvbnNlKEJhc2VNb2RlbCk6CiAgICBpZDogaW50CiAgICB1c2VybmFtZTogc3RyCiAgICByb2xlOiBzdHIKICAgIGRpc3BsYXlfbmFtZTogT3B0aW9uYWxbc3RyXSA9IE5vbmUKICAgIGlzX2FjdGl2ZTogYm9vbAogICAgY3JlYXRlZF9hdDogT3B0aW9uYWxbc3RyXSA9IE5vbmUKICAgIGxhc3RfbG9naW46IE9wdGlvbmFsW3N0cl0gPSBOb25lCgoKIyA9PT0gQWdlbnRzICjsm5DqsqkgUEMpID09PQpjbGFzcyBBZ2VudFJlZ2lzdGVyKEJhc2VNb2RlbCk6CiAgICBhZ2VudF9pZDogc3RyICAgICAgICAgICAjIGhvc3RuYW1lIOuYkOuKlCBVVUlECiAgICBob3N0bmFtZTogc3RyCiAgICBvc19pbmZvOiBzdHIgPSAiIgogICAgaXA6IHN0ciA9ICIiCiAgICBpcF9wdWJsaWM6IHN0ciA9ICIiICAgICAjIOqzteyduElQIChQMlDsmqksIExpbmtJT+ydmCBJcDEpCiAgICB3c19wb3J0OiBpbnQgPSAyMTM1MCAgICAjIOyXkOydtOyghO2KuCBXUyDshJzrsoQg7Y+s7Yq4IChQMlDsmqkpCiAgICBtYWNfYWRkcmVzczogc3RyID0gIiIKICAgIHNjcmVlbl93aWR0aDogaW50ID0gMTkyMAogICAgc2NyZWVuX2hlaWdodDogaW50ID0gMTA4MAogICAgYWdlbnRfdmVyc2lvbjogc3RyID0gIiIgICMg7JeQ7J207KCE7Yq4IOyGjO2UhO2KuOybqOyWtCDrsoTsoIQgKOyXheuNsOydtO2EsOyaqSkKICAgIGNwdV9tb2RlbDogc3RyID0gIiIKICAgIGNwdV9jb3JlczogaW50ID0gMAogICAgcmFtX2diOiBmbG9hdCA9IDAuMAogICAgbW90aGVyYm9hcmQ6IHN0ciA9ICIiCiAgICBncHVfbW9kZWw6IHN0ciA9ICIiCgoKY2xhc3MgQWdlbnRIZWFydGJlYXQoQmFzZU1vZGVsKToKICAgIGFnZW50X2lkOiBzdHIKICAgIGlwOiBzdHIgPSAiIgogICAgaXBfcHVibGljOiBzdHIgPSAiIgogICAgd3NfcG9ydDogaW50ID0gMjEzNTAKICAgIHNjcmVlbl93aWR0aDogaW50ID0gMTkyMAogICAgc2NyZWVuX2hlaWdodDogaW50ID0gMTA4MAogICAgYWdlbnRfdmVyc2lvbjogc3RyID0gIiIgICMg7JeQ7J207KCE7Yq4IOyGjO2UhO2KuOybqOyWtCDrsoTsoIQgKOyXheuNsOydtO2EsOyaqSkKCgpjbGFzcyBBZ2VudFJlc3BvbnNlKEJhc2VNb2RlbCk6CiAgICBpZDogaW50CiAgICBhZ2VudF9pZDogc3RyCiAgICBob3N0bmFtZTogc3RyCiAgICBvc19pbmZvOiBzdHIgPSAiIgogICAgaXA6IHN0ciA9ICIiCiAgICBpcF9wdWJsaWM6IHN0ciA9ICIiCiAgICB3c19wb3J0OiBpbnQgPSAyMTM1MAogICAgbWFjX2FkZHJlc3M6IHN0ciA9ICIiCiAgICBzY3JlZW5fd2lkdGg6IGludCA9IDE5MjAKICAgIHNjcmVlbl9oZWlnaHQ6IGludCA9IDEwODAKICAgIGdyb3VwX25hbWU6IHN0ciA9ICJkZWZhdWx0IgogICAgZGlzcGxheV9uYW1lOiBPcHRpb25hbFtzdHJdID0gTm9uZQogICAgaXNfb25saW5lOiBib29sID0gRmFsc2UKICAgIG93bmVyX2lkOiBpbnQgPSAwCiAgICBvd25lcl91c2VybmFtZTogc3RyID0gIiIKICAgIGxhc3Rfc2VlbjogT3B0aW9uYWxbc3RyXSA9IE5vbmUKICAgIGFnZW50X3ZlcnNpb246IHN0ciA9ICIiICAjIOyXkOydtOyghO2KuCDshoztlITtirjsm6jslrQg67KE7KCEICjsl4XrjbDsnbTthLDsmqkpCiAgICBjcHVfbW9kZWw6IHN0ciA9ICIiCiAgICBjcHVfY29yZXM6IGludCA9IDAKICAgIHJhbV9nYjogZmxvYXQgPSAwLjAKICAgIG1vdGhlcmJvYXJkOiBzdHIgPSAiIgogICAgZ3B1X21vZGVsOiBzdHIgPSAiIgoKCiMgPT09IEdyb3VwcyA9PT0KY2xhc3MgR3JvdXBDcmVhdGUoQmFzZU1vZGVsKToKICAgIG5hbWU6IHN0cgogICAgZGVzY3JpcHRpb246IE9wdGlvbmFsW3N0cl0gPSBOb25lCgoKY2xhc3MgR3JvdXBSZXNwb25zZShCYXNlTW9kZWwpOgogICAgaWQ6IGludAogICAgbmFtZTogc3RyCiAgICBkZXNjcmlwdGlvbjogT3B0aW9uYWxbc3RyXSA9IE5vbmUKICAgIG93bmVyX2lkOiBPcHRpb25hbFtpbnRdID0gTm9uZQo="
MAIN_B64 = "IiIiCldlbGxjb21TT0ZUIEFQSSDshJzrsoQKRmFzdEFQSSArIE15U1FMICsgSldUIOyduOymnQoK7ZW17IusIO2dkOumhDoKMS4g7JeQ7J207KCE7Yq4KOuMgOyDgVBDKeqwgCDshJzrsoTsl5Ag66Gc6re47J24IOKGkiBKV1Qg7Yag7YGwIO2ajeuTnQoyLiDsl5DsnbTsoITtirjqsIAgL2FwaS9hZ2VudHMvcmVnaXN0ZXLroZwg7J6Q7Iug7J2EIOuTseuhnSAob3duZXJfaWQgPSDroZzqt7jsnbgg7IKs7Jqp7J6QKQozLiDsl5DsnbTsoITtirjqsIAgL2FwaS9hZ2VudHMvaGVhcnRiZWF066GcIOyjvOq4sOyggeycvOuhnCDsg4Htg5wg67O06rOgCjQuIOunpOuLiOyggCjqtIDrpqxQQynqsIAg6rCZ7J2AIOqzhOygleycvOuhnCDroZzqt7jsnbgg4oaSIC9hcGkvYWdlbnRz66GcIO2VtOuLuSDsgqzsmqnsnpDsnZgg7JeQ7J207KCE7Yq4IOuqqeuhnSDsobDtmowKNS4g66ek64uI7KCA6rCAIOyXkOydtOyghO2KuOydmCBJUOulvCDslYzslYTrgrTshJwgV2ViU29ja2V0IOyngeygkSDsl7DqsrAKICAgT1Ig7Y+s7Yq4IOqwnOuwqSDrtojqsIAg7IucIOKGkiAvd3MvbWFuYWdlciwgL3dzL2FnZW50IOumtOugiOydtOulvCDthrXtlbQg7ISc67KEIOykkeqzhAoiIiIKaW1wb3J0IGFzeW5jaW8KaW1wb3J0IGpzb24KaW1wb3J0IG9zCmltcG9ydCBzZWNyZXRzCmltcG9ydCB0aW1lCmZyb20gY29sbGVjdGlvbnMgaW1wb3J0IGRlZmF1bHRkaWN0CmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lLCB0aW1lZGVsdGEsIHRpbWV6b25lCmZyb20gdHlwaW5nIGltcG9ydCBPcHRpb25hbAoKZnJvbSBmYXN0YXBpIGltcG9ydCBGYXN0QVBJLCBEZXBlbmRzLCBIVFRQRXhjZXB0aW9uLCBRdWVyeSwgUmVxdWVzdCwgV2ViU29ja2V0LCBXZWJTb2NrZXREaXNjb25uZWN0CmZyb20gZmFzdGFwaS5taWRkbGV3YXJlLmNvcnMgaW1wb3J0IENPUlNNaWRkbGV3YXJlCgpmcm9tIGF1dGggaW1wb3J0ICgKICAgIGhhc2hfcGFzc3dvcmQsIHZlcmlmeV9wYXNzd29yZCwgY3JlYXRlX3Rva2VuLAogICAgZ2V0X2N1cnJlbnRfdXNlciwgcmVxdWlyZV9hZG1pbiwgZGVjb2RlX3Rva2VuLAopCmZyb20gZGF0YWJhc2UgaW1wb3J0IGdldF9kYgpmcm9tIG1vZGVscyBpbXBvcnQgKAogICAgTG9naW5SZXF1ZXN0LCBMb2dpblJlc3BvbnNlLCBVc2VySW5mbywKICAgIFVzZXJDcmVhdGUsIFVzZXJVcGRhdGUsIFVzZXJSZXNwb25zZSwKICAgIEFnZW50UmVnaXN0ZXIsIEFnZW50SGVhcnRiZWF0LCBBZ2VudFJlc3BvbnNlLAogICAgR3JvdXBDcmVhdGUsIEdyb3VwUmVzcG9uc2UsCikKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyDshJzrsoQg66a066CI7J20IOyDge2DnCAo66mU66qo66asLCDri6jsnbwg7ZSE66Gc7IS47IqkKQojIOyXkOydtOyghO2KuOqwgCDslYTsm4PrsJTsmrTrk5zroZwg7Jew6rKwIOKGkiDtj6ztirgg6rCc67CpIOu2iO2VhOyalCDtj7TrsLEKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpfcmVsYXlfYWdlbnRzOiBkaWN0ID0ge30gICAjIGFnZW50X2lkIOKGkiBXZWJTb2NrZXQgKOyXkOydtOyghO2KuCDsuKEpCl9yZWxheV9tYW5hZ2Vyczogc2V0ID0gc2V0KCkgICMg7Jew6rKw65CcIOunpOuLiOyggCBXZWJTb2NrZXQg66qp66GdIChzZXQ6IE8oMSkg7LaU6rCAL+yCreygnCkKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyDroZzqt7jsnbgg7IaN64+EIOygnO2VnCAo67iM66Oo7Yq47Y+s7IqkIOuwqeyngCkKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpfbG9naW5fYXR0ZW1wdHM6IGRpY3QgPSBkZWZhdWx0ZGljdChsaXN0KSAgICMgSVAg4oaSIFt0aW1lc3RhbXAsIC4uLl0KUkFURV9MSU1JVF9XSU5ET1cgPSA2MCAgICAgICMg7LSIClJBVEVfTElNSVRfTUFYID0gMTAgICAgICAgICAjIOywveuLuSDstZzrjIAg7Iuc64+ECgpSRUxBWV9BR0VOVF9JRF9MRU4gPSAzMgoKCmRlZiBfcmVsYXlfcGFkKGFnZW50X2lkOiBzdHIpIC0+IGJ5dGVzOgogICAgcmV0dXJuIGFnZW50X2lkLmVuY29kZSgidXRmLTgiKVs6UkVMQVlfQUdFTlRfSURfTEVOXS5sanVzdChSRUxBWV9BR0VOVF9JRF9MRU4sIGIiXHgwMCIpCgoKZGVmIF9yZWxheV91bnBhZChkYXRhOiBieXRlcykgLT4gc3RyOgogICAgcmV0dXJuIGRhdGFbOlJFTEFZX0FHRU5UX0lEX0xFTl0ucnN0cmlwKGIiXHgwMCIpLmRlY29kZSgidXRmLTgiLCBlcnJvcnM9InJlcGxhY2UiKQoKYXBwID0gRmFzdEFQSSh0aXRsZT0iV2VsbGNvbVNPRlQgQVBJIiwgdmVyc2lvbj0iMS4wLjAiKQoKYXBwLmFkZF9taWRkbGV3YXJlKAogICAgQ09SU01pZGRsZXdhcmUsCiAgICBhbGxvd19vcmlnaW5zPVsiKiJdLAogICAgYWxsb3dfbWV0aG9kcz1bIioiXSwKICAgIGFsbG93X2hlYWRlcnM9WyIqIl0sCikKCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgV2ViU29ja2V0IOumtOugiOydtCAo7Y+s7Yq4IDIxMzUwIOqwnOuwqSDrtojqsIAg7IucIO2PtOuwsSkKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKQGFwcC53ZWJzb2NrZXQoIi93cy9hZ2VudCIpCmFzeW5jIGRlZiB3c19hZ2VudF9yZWxheSh3ZWJzb2NrZXQ6IFdlYlNvY2tldCwgdG9rZW46IHN0ciA9IFF1ZXJ5KGRlZmF1bHQ9IiIpKToKICAgICIiIuyXkOydtOyghO2KuCDihpIg7ISc67KEIOyVhOybg+uwlOyatOuTnCDrprTroIjsnbQg7Jew6rKwICjtj6ztirgg6rCc67CpIOu2iO2VhOyalCkiIiIKICAgIGF3YWl0IHdlYnNvY2tldC5hY2NlcHQoKQoKICAgICMgSldUIOqygOymnQogICAgdHJ5OgogICAgICAgIHBheWxvYWQgPSBkZWNvZGVfdG9rZW4odG9rZW4pCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIGF3YWl0IHdlYnNvY2tldC5jbG9zZShjb2RlPTQwMDEsIHJlYXNvbj0iVW5hdXRob3JpemVkIikKICAgICAgICByZXR1cm4KCiAgICAjIOyXkOydtOyghO2KuCBoZWxsbyDtlbjrk5zshbDsnbTtgawKICAgIGFnZW50X2lkID0gTm9uZQogICAgdHJ5OgogICAgICAgIHJhdyA9IGF3YWl0IGFzeW5jaW8ud2FpdF9mb3Iod2Vic29ja2V0LnJlY2VpdmVfdGV4dCgpLCB0aW1lb3V0PTEwKQogICAgICAgIGluaXQgPSBqc29uLmxvYWRzKHJhdykKICAgICAgICBpZiBpbml0LmdldCgidHlwZSIpID09ICJhZ2VudF9oZWxsbyI6CiAgICAgICAgICAgIGFnZW50X2lkID0gc3RyKGluaXQuZ2V0KCJhZ2VudF9pZCIsICIiKSkuc3RyaXAoKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgogICAgaWYgbm90IGFnZW50X2lkOgogICAgICAgIGF3YWl0IHdlYnNvY2tldC5jbG9zZShjb2RlPTQwMDAsIHJlYXNvbj0iTm8gYWdlbnRfaWQiKQogICAgICAgIHJldHVybgoKICAgIF9yZWxheV9hZ2VudHNbYWdlbnRfaWRdID0gd2Vic29ja2V0CiAgICBhd2FpdCB3ZWJzb2NrZXQuc2VuZF90ZXh0KGpzb24uZHVtcHMoeyJ0eXBlIjogInJlbGF5X29rIn0pKQoKICAgICMg66ek64uI7KCA65Ok7JeQ6rKMIOyXkOydtOyghO2KuCDsoJHsho0g7JWM66a8CiAgICBub3RpZnkgPSBqc29uLmR1bXBzKHsidHlwZSI6ICJhZ2VudF9jb25uZWN0ZWQiLCAic291cmNlX2FnZW50IjogYWdlbnRfaWR9KQogICAgZm9yIG1fd3MgaW4gbGlzdChfcmVsYXlfbWFuYWdlcnMpOgogICAgICAgIHRyeToKICAgICAgICAgICAgYXdhaXQgbV93cy5zZW5kX3RleHQobm90aWZ5KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgIHByaW50KGYiW1JlbGF5XSDsl5DsnbTsoITtirgg7KCR7IaNOiB7YWdlbnRfaWR9IikKCiAgICB0cnk6CiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgZGF0YSA9IGF3YWl0IHdlYnNvY2tldC5yZWNlaXZlKCkKICAgICAgICAgICAgaWYgZGF0YS5nZXQoInR5cGUiKSA9PSAid2Vic29ja2V0LmRpc2Nvbm5lY3QiOgogICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIHRleHQgPSBkYXRhLmdldCgidGV4dCIpCiAgICAgICAgICAgIHJhd19ieXRlcyA9IGRhdGEuZ2V0KCJieXRlcyIpCgogICAgICAgICAgICBpZiB0ZXh0OgogICAgICAgICAgICAgICAgIyBKU09OOiBzb3VyY2VfYWdlbnQg7LaU6rCAIO2bhCDrqqjrk6Ag66ek64uI7KCA7JeQ6rKMIOu4jOuhnOuTnOy6kOyKpO2KuAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG1zZyA9IGpzb24ubG9hZHModGV4dCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIG1zZ1sic291cmNlX2FnZW50Il0gPSBhZ2VudF9pZAogICAgICAgICAgICAgICAgZndkID0ganNvbi5kdW1wcyhtc2cpCiAgICAgICAgICAgICAgICBmb3IgbV93cyBpbiBsaXN0KF9yZWxheV9tYW5hZ2Vycyk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBtX3dzLnNlbmRfdGV4dChmd2QpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgZWxpZiByYXdfYnl0ZXM6CiAgICAgICAgICAgICAgICAjIOuwlOydtOuEiOumrDogMzJCIGFnZW50X2lkIOygkeuRkOyWtCDstpTqsIAg7ZuEIOu4jOuhnOuTnOy6kOyKpO2KuAogICAgICAgICAgICAgICAgZndkID0gX3JlbGF5X3BhZChhZ2VudF9pZCkgKyByYXdfYnl0ZXMKICAgICAgICAgICAgICAgIGZvciBtX3dzIGluIGxpc3QoX3JlbGF5X21hbmFnZXJzKToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IG1fd3Muc2VuZF9ieXRlcyhmd2QpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgIGV4Y2VwdCAoV2ViU29ja2V0RGlzY29ubmVjdCwgRXhjZXB0aW9uKToKICAgICAgICBwYXNzCiAgICBmaW5hbGx5OgogICAgICAgIF9yZWxheV9hZ2VudHMucG9wKGFnZW50X2lkLCBOb25lKQogICAgICAgICMg66ek64uI7KCA65Ok7JeQ6rKMIOyXkOydtOyghO2KuCDtlbTsoJwg7JWM66a8CiAgICAgICAgbm90aWZ5ID0ganNvbi5kdW1wcyh7InR5cGUiOiAiYWdlbnRfZGlzY29ubmVjdGVkIiwgInNvdXJjZV9hZ2VudCI6IGFnZW50X2lkfSkKICAgICAgICBmb3IgbV93cyBpbiBsaXN0KF9yZWxheV9tYW5hZ2Vycyk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGF3YWl0IG1fd3Muc2VuZF90ZXh0KG5vdGlmeSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBwcmludChmIltSZWxheV0g7JeQ7J207KCE7Yq4IO2VtOygnDoge2FnZW50X2lkfSIpCgoKQGFwcC53ZWJzb2NrZXQoIi93cy9tYW5hZ2VyIikKYXN5bmMgZGVmIHdzX21hbmFnZXJfcmVsYXkod2Vic29ja2V0OiBXZWJTb2NrZXQsIHRva2VuOiBzdHIgPSBRdWVyeShkZWZhdWx0PSIiKSk6CiAgICAiIiLrp6Tri4jsoIAg4oaSIOyEnOuyhCDrprTroIjsnbQg7Jew6rKwIChQMlAg7Iuk7YyoIOyLnCDtj7TrsLEpIiIiCiAgICBhd2FpdCB3ZWJzb2NrZXQuYWNjZXB0KCkKCiAgICAjIEpXVCDqsoDspp0KICAgIHRyeToKICAgICAgICBkZWNvZGVfdG9rZW4odG9rZW4pCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIGF3YWl0IHdlYnNvY2tldC5jbG9zZShjb2RlPTQwMDEsIHJlYXNvbj0iVW5hdXRob3JpemVkIikKICAgICAgICByZXR1cm4KCiAgICBfcmVsYXlfbWFuYWdlcnMuYWRkKHdlYnNvY2tldCkKICAgIGF3YWl0IHdlYnNvY2tldC5zZW5kX3RleHQoanNvbi5kdW1wcyh7InR5cGUiOiAicmVsYXlfb2sifSkpCgogICAgIyDtmITsnqwg7Jew6rKw65CcIOyXkOydtOyghO2KuCDrqqnroZ0g7KCE64usCiAgICBmb3IgYWlkIGluIGxpc3QoX3JlbGF5X2FnZW50cy5rZXlzKCkpOgogICAgICAgIHRyeToKICAgICAgICAgICAgYXdhaXQgd2Vic29ja2V0LnNlbmRfdGV4dCgKICAgICAgICAgICAgICAgIGpzb24uZHVtcHMoeyJ0eXBlIjogImFnZW50X2Nvbm5lY3RlZCIsICJzb3VyY2VfYWdlbnQiOiBhaWR9KQogICAgICAgICAgICApCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgcHJpbnQoZiJbUmVsYXldIOunpOuLiOyggCDsoJHsho0gKOumtOugiOydtCDsl5DsnbTsoITtirg6IHtsZW4oX3JlbGF5X2FnZW50cyl96rCcKSIpCgogICAgdHJ5OgogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIGRhdGEgPSBhd2FpdCB3ZWJzb2NrZXQucmVjZWl2ZSgpCiAgICAgICAgICAgIGlmIGRhdGEuZ2V0KCJ0eXBlIikgPT0gIndlYnNvY2tldC5kaXNjb25uZWN0IjoKICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICB0ZXh0ID0gZGF0YS5nZXQoInRleHQiKQogICAgICAgICAgICByYXdfYnl0ZXMgPSBkYXRhLmdldCgiYnl0ZXMiKQoKICAgICAgICAgICAgaWYgdGV4dDoKICAgICAgICAgICAgICAgICMgSlNPTjogdGFyZ2V0X2FnZW50IOy2lOy2nCDihpIg7ZW064u5IOyXkOydtOyghO2KuOyXkCDsoITri6wKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBtc2cgPSBqc29uLmxvYWRzKHRleHQpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB0YXJnZXQgPSBtc2cucG9wKCJ0YXJnZXRfYWdlbnQiLCBOb25lKQogICAgICAgICAgICAgICAgaWYgdGFyZ2V0OgogICAgICAgICAgICAgICAgICAgIGFnZW50X3dzID0gX3JlbGF5X2FnZW50cy5nZXQodGFyZ2V0KQogICAgICAgICAgICAgICAgICAgIGlmIGFnZW50X3dzOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBhZ2VudF93cy5zZW5kX3RleHQoanNvbi5kdW1wcyhtc2cpKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgZWxpZiByYXdfYnl0ZXM6CiAgICAgICAgICAgICAgICAjIOuwlOydtOuEiOumrDog7JWeIDMyQiA9IHRhcmdldCBhZ2VudF9pZAogICAgICAgICAgICAgICAgaWYgbGVuKHJhd19ieXRlcykgPCBSRUxBWV9BR0VOVF9JRF9MRU4gKyAxOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB0YXJnZXQgPSBfcmVsYXlfdW5wYWQocmF3X2J5dGVzWzpSRUxBWV9BR0VOVF9JRF9MRU5dKQogICAgICAgICAgICAgICAgcGF5bG9hZCA9IHJhd19ieXRlc1tSRUxBWV9BR0VOVF9JRF9MRU46XQogICAgICAgICAgICAgICAgYWdlbnRfd3MgPSBfcmVsYXlfYWdlbnRzLmdldCh0YXJnZXQpCiAgICAgICAgICAgICAgICBpZiBhZ2VudF93czoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGFnZW50X3dzLnNlbmRfYnl0ZXMocGF5bG9hZCkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgZXhjZXB0IChXZWJTb2NrZXREaXNjb25uZWN0LCBFeGNlcHRpb24pOgogICAgICAgIHBhc3MKICAgIGZpbmFsbHk6CiAgICAgICAgX3JlbGF5X21hbmFnZXJzLmRpc2NhcmQod2Vic29ja2V0KQogICAgICAgIHByaW50KCJbUmVsYXldIOunpOuLiOyggCDtlbTsoJwiKQoKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyDsi5zsnpEg7IucIO2FjOydtOu4lCDstIjquLDtmZQKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpAYXBwLm9uX2V2ZW50KCJzdGFydHVwIikKYXN5bmMgZGVmIHN0YXJ0dXBfaW5pdCgpOgogICAgd2l0aCBnZXRfZGIoKSBhcyBjb25uOgogICAgICAgIHdpdGggY29ubi5jdXJzb3IoKSBhcyBjdXI6CiAgICAgICAgICAgICMgdXNlcnMg7YWM7J2067iUCiAgICAgICAgICAgIGN1ci5leGVjdXRlKCIiIgogICAgICAgICAgICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgdXNlcnMgKAogICAgICAgICAgICAgICAgICAgIGlkIElOVCBBVVRPX0lOQ1JFTUVOVCBQUklNQVJZIEtFWSwKICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSBWQVJDSEFSKDUwKSBVTklRVUUgTk9UIE5VTEwsCiAgICAgICAgICAgICAgICAgICAgcGFzc3dvcmQgVkFSQ0hBUigyNTUpIE5PVCBOVUxMLAogICAgICAgICAgICAgICAgICAgIHJvbGUgVkFSQ0hBUigyMCkgREVGQVVMVCAndXNlcicsCiAgICAgICAgICAgICAgICAgICAgZGlzcGxheV9uYW1lIFZBUkNIQVIoMTAwKSwKICAgICAgICAgICAgICAgICAgICBpc19hY3RpdmUgQk9PTEVBTiBERUZBVUxUIFRSVUUsCiAgICAgICAgICAgICAgICAgICAgY3JlYXRlZF9hdCBEQVRFVElNRSBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QLAogICAgICAgICAgICAgICAgICAgIGxhc3RfbG9naW4gREFURVRJTUUKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgIiIiKQoKICAgICAgICAgICAgIyBhZ2VudHMg7YWM7J2067iUICjsl5DsnbTsoITtirggPSDsm5DqsqkgUEMpCiAgICAgICAgICAgIGN1ci5leGVjdXRlKCIiIgogICAgICAgICAgICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgYWdlbnRzICgKICAgICAgICAgICAgICAgICAgICBpZCBJTlQgQVVUT19JTkNSRU1FTlQgUFJJTUFSWSBLRVksCiAgICAgICAgICAgICAgICAgICAgYWdlbnRfaWQgVkFSQ0hBUigyNTUpIE5PVCBOVUxMLAogICAgICAgICAgICAgICAgICAgIG93bmVyX2lkIElOVCBOT1QgTlVMTCwKICAgICAgICAgICAgICAgICAgICBob3N0bmFtZSBWQVJDSEFSKDI1NSkgREVGQVVMVCAnJywKICAgICAgICAgICAgICAgICAgICBkaXNwbGF5X25hbWUgVkFSQ0hBUigyNTUpIERFRkFVTFQgTlVMTCwKICAgICAgICAgICAgICAgICAgICBvc19pbmZvIFZBUkNIQVIoMjU1KSBERUZBVUxUICcnLAogICAgICAgICAgICAgICAgICAgIGlwIFZBUkNIQVIoNTApIERFRkFVTFQgJycsCiAgICAgICAgICAgICAgICAgICAgbWFjX2FkZHJlc3MgVkFSQ0hBUig1MCkgREVGQVVMVCAnJywKICAgICAgICAgICAgICAgICAgICBzY3JlZW5fd2lkdGggSU5UIERFRkFVTFQgMTkyMCwKICAgICAgICAgICAgICAgICAgICBzY3JlZW5faGVpZ2h0IElOVCBERUZBVUxUIDEwODAsCiAgICAgICAgICAgICAgICAgICAgZ3JvdXBfbmFtZSBWQVJDSEFSKDEwMCkgREVGQVVMVCAnZGVmYXVsdCcsCiAgICAgICAgICAgICAgICAgICAgaXNfb25saW5lIEJPT0xFQU4gREVGQVVMVCBGQUxTRSwKICAgICAgICAgICAgICAgICAgICBsYXN0X3NlZW4gREFURVRJTUUsCiAgICAgICAgICAgICAgICAgICAgY3JlYXRlZF9hdCBEQVRFVElNRSBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QLAogICAgICAgICAgICAgICAgICAgIFVOSVFVRSBLRVkgdXFfYWdlbnRfb3duZXIgKGFnZW50X2lkLCBvd25lcl9pZCksCiAgICAgICAgICAgICAgICAgICAgRk9SRUlHTiBLRVkgKG93bmVyX2lkKSBSRUZFUkVOQ0VTIHVzZXJzKGlkKSBPTiBERUxFVEUgQ0FTQ0FERQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAiIiIpCgogICAgICAgICAgICAjIGFnZW50X2dyb3VwcyDthYzsnbTruJQKICAgICAgICAgICAgY3VyLmV4ZWN1dGUoIiIiCiAgICAgICAgICAgICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBhZ2VudF9ncm91cHMgKAogICAgICAgICAgICAgICAgICAgIGlkIElOVCBBVVRPX0lOQ1JFTUVOVCBQUklNQVJZIEtFWSwKICAgICAgICAgICAgICAgICAgICBuYW1lIFZBUkNIQVIoMTAwKSBOT1QgTlVMTCwKICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiBURVhULAogICAgICAgICAgICAgICAgICAgIG93bmVyX2lkIElOVCwKICAgICAgICAgICAgICAgICAgICBjcmVhdGVkX2F0IERBVEVUSU1FIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAsCiAgICAgICAgICAgICAgICAgICAgVU5JUVVFIEtFWSB1cV9ncm91cF9vd25lciAobmFtZSwgb3duZXJfaWQpLAogICAgICAgICAgICAgICAgICAgIEZPUkVJR04gS0VZIChvd25lcl9pZCkgUkVGRVJFTkNFUyB1c2VycyhpZCkgT04gREVMRVRFIENBU0NBREUKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgIiIiKQoKICAgICAgICAgICAgIyBQMlDsmqkg7Lus65+8IOy2lOqwgCAodjMuMC4wKSArIOyXheuNsOydtO2EsOyaqSDsu6zrn7wgKHYzLjEuMCkgKyDtlZjrk5zsm6jslrQg7Lus65+8ICh2My4wLjcpCiAgICAgICAgICAgIGZvciBjb2xfbmFtZSwgY29sX2RlZiBpbiBbCiAgICAgICAgICAgICAgICAoJ2lwX3B1YmxpYycsICJWQVJDSEFSKDUwKSBERUZBVUxUICcnIiksCiAgICAgICAgICAgICAgICAoJ3dzX3BvcnQnLCAiSU5UIERFRkFVTFQgMjEzNTAiKSwKICAgICAgICAgICAgICAgICgnYWdlbnRfdmVyc2lvbicsICJWQVJDSEFSKDIwKSBERUZBVUxUICcnIiksCiAgICAgICAgICAgICAgICAoJ2NwdV9tb2RlbCcsICJWQVJDSEFSKDI1NSkgREVGQVVMVCAnJyIpLAogICAgICAgICAgICAgICAgKCdjcHVfY29yZXMnLCAiSU5UIERFRkFVTFQgMCIpLAogICAgICAgICAgICAgICAgKCdyYW1fZ2InLCAiRkxPQVQgREVGQVVMVCAwLjAiKSwKICAgICAgICAgICAgICAgICgnbW90aGVyYm9hcmQnLCAiVkFSQ0hBUigyNTUpIERFRkFVTFQgJyciKSwKICAgICAgICAgICAgICAgICgnZ3B1X21vZGVsJywgIlZBUkNIQVIoMjU1KSBERUZBVUxUICcnIiksCiAgICAgICAgICAgIF06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgY3VyLmV4ZWN1dGUoZiJBTFRFUiBUQUJMRSBhZ2VudHMgQUREIENPTFVNTiB7Y29sX25hbWV9IHtjb2xfZGVmfSIpCiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbSW5pdF0gYWdlbnRzIO2FjOydtOu4lOyXkCB7Y29sX25hbWV9IOy7rOufvCDstpTqsIAiKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzICAjIOydtOuvuCDsobTsnqwKCiAgICAgICAgICAgICMgYWRtaW4g6rOE7KCVIOy0iOq4sO2ZlAogICAgICAgICAgICBjdXIuZXhlY3V0ZSgiU0VMRUNUIGlkLCBwYXNzd29yZCBGUk9NIHVzZXJzIFdIRVJFIHVzZXJuYW1lID0gJ2FkbWluJyIpCiAgICAgICAgICAgIGFkbWluID0gY3VyLmZldGNob25lKCkKICAgICAgICAgICAgaWYgbm90IGFkbWluOgogICAgICAgICAgICAgICAgIyDstZzstIgg7IOd7ISxOiDrrLTsnpHsnIQg67mE67CA67KI7Zi4IOyDneyEsQogICAgICAgICAgICAgICAgcmFuZG9tX3B3ID0gc2VjcmV0cy50b2tlbl91cmxzYWZlKDEyKQogICAgICAgICAgICAgICAgaGFzaGVkID0gaGFzaF9wYXNzd29yZChyYW5kb21fcHcpCiAgICAgICAgICAgICAgICBjdXIuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICAgICAiSU5TRVJUIElOVE8gdXNlcnMgKHVzZXJuYW1lLCBwYXNzd29yZCwgcm9sZSwgZGlzcGxheV9uYW1lKSBWQUxVRVMgKCVzLCAlcywgJ2FkbWluJywgJ+q0gOumrOyekCcpIiwKICAgICAgICAgICAgICAgICAgICAoImFkbWluIiwgaGFzaGVkKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgcHJpbnQoIj0iICogNjApCiAgICAgICAgICAgICAgICBwcmludChmIltJbml0XSBhZG1pbiDqs4TsoJUg7IOd7ISxIikKICAgICAgICAgICAgICAgIHByaW50KGYiW0luaXRdIOKYhSDstIjquLAg67mE67CA67KI7Zi4OiB7cmFuZG9tX3B3fSIpCiAgICAgICAgICAgICAgICBwcmludChmIltJbml0XSDimIUg66Gc6re47J24IO2bhCDrsJjrk5zsi5wg67mE67CA67KI7Zi466W8IOuzgOqyve2VmOyEuOyalCEiKQogICAgICAgICAgICAgICAgcHJpbnQoIj0iICogNjApCiAgICAgICAgICAgIGVsaWYgYWRtaW4gYW5kIG5vdCBhZG1pblsicGFzc3dvcmQiXS5zdGFydHN3aXRoKCIkMmIkIik6CiAgICAgICAgICAgICAgICBoYXNoZWQgPSBoYXNoX3Bhc3N3b3JkKCJhZG1pbiIpCiAgICAgICAgICAgICAgICBjdXIuZXhlY3V0ZSgiVVBEQVRFIHVzZXJzIFNFVCBwYXNzd29yZCA9ICVzIFdIRVJFIGlkID0gJXMiLCAoaGFzaGVkLCBhZG1pblsiaWQiXSkpCiAgICAgICAgICAgICAgICBwcmludCgiW0luaXRdIGFkbWluIOu5hOuwgOuyiO2YuCBiY3J5cHQg7ZW07IuxIOyZhOujjCIpCgogICAgcHJpbnQoIltJbml0XSDrjbDsnbTthLDrsqDsnbTsiqQg7LSI6riw7ZmUIOyZhOujjCIpCgogICAgIyDrsLHqt7jrnbzsmrTrk5wg7YOc7Iqk7YGsOiDsmKTrnpjrkJwg7JeQ7J207KCE7Yq4IOyYpO2UhOudvOyduCDsspjrpqwKICAgIGFzeW5jaW8uY3JlYXRlX3Rhc2soX2NsZWFudXBfc3RhbGVfYWdlbnRzKCkpCgoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIEF1dGgKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQphc3luYyBkZWYgX2NsZWFudXBfc3RhbGVfYWdlbnRzKCk6CiAgICAiIiLtlZjtirjruYTtirgg66+47IiY7IugIOyXkOydtOyghO2KuCDsnpDrj5kg7Jik7ZSE65287J24IOyymOumrCAoM+u2hCDsnbTsg4Eg66+47J2R64u1KSIiIgogICAgU1RBTEVfTUlOVVRFUyA9IDMKICAgIHdoaWxlIFRydWU6CiAgICAgICAgYXdhaXQgYXN5bmNpby5zbGVlcCgxMjApICAgIyAy67aE66eI64ukIOyLpO2WiQogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBnZXRfZGIoKSBhcyBjb25uOgogICAgICAgICAgICAgICAgd2l0aCBjb25uLmN1cnNvcigpIGFzIGN1cjoKICAgICAgICAgICAgICAgICAgICBjdXIuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgICAgICAgICAgICAgVVBEQVRFIGFnZW50cyBTRVQgaXNfb25saW5lID0gRkFMU0UKICAgICAgICAgICAgICAgICAgICAgICAgV0hFUkUgaXNfb25saW5lID0gVFJVRQogICAgICAgICAgICAgICAgICAgICAgICAgIEFORCBsYXN0X3NlZW4gPCAlcwogICAgICAgICAgICAgICAgICAgICIiIiwgKGRhdGV0aW1lLm5vdyh0aW1lem9uZS51dGMpIC0gdGltZWRlbHRhKG1pbnV0ZXM9U1RBTEVfTUlOVVRFUyksKSkKICAgICAgICAgICAgICAgICAgICBpZiBjdXIucm93Y291bnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0NsZWFudXBdIOyYpO2UhOudvOyduCDsspjrpqw6IHtjdXIucm93Y291bnR96rCcIOyXkOydtOyghO2KuCAo66eI7KeA66eJIO2VmO2KuOu5hO2KuCB7U1RBTEVfTUlOVVRFU33rtoQg7LSI6rO8KSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltDbGVhbnVwXSDsmKTrpZg6IHtlfSIpCgoKZGVmIF9jaGVja19yYXRlX2xpbWl0KGlwOiBzdHIpOgogICAgIiIi66Gc6re47J24IOyGjeuPhCDsoJztlZwg7ZmV7J24IChJUOuLuSB7UkFURV9MSU1JVF9NQVh97ZqML3tSQVRFX0xJTUlUX1dJTkRPV33stIgpIiIiCiAgICBub3cgPSB0aW1lLnRpbWUoKQogICAgYXR0ZW1wdHMgPSBfbG9naW5fYXR0ZW1wdHNbaXBdCiAgICAjIOyYpOuemOuQnCDsi5zrj4Qg7KCc6rGwCiAgICBfbG9naW5fYXR0ZW1wdHNbaXBdID0gW3QgZm9yIHQgaW4gYXR0ZW1wdHMgaWYgbm93IC0gdCA8IFJBVEVfTElNSVRfV0lORE9XXQogICAgaWYgbGVuKF9sb2dpbl9hdHRlbXB0c1tpcF0pID49IFJBVEVfTElNSVRfTUFYOgogICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24oCiAgICAgICAgICAgIHN0YXR1c19jb2RlPTQyOSwKICAgICAgICAgICAgZGV0YWlsPWYi66Gc6re47J24IOyLnOuPhCDtmp/siJgg7LSI6rO8ICh7UkFURV9MSU1JVF9NQVh97ZqML3tSQVRFX0xJTUlUX1dJTkRPV33stIgpLiDsnqDsi5wg7ZuEIOuLpOyLnCDsi5zrj4TtlZjshLjsmpQuIiwKICAgICAgICApCiAgICBfbG9naW5fYXR0ZW1wdHNbaXBdLmFwcGVuZChub3cpCgoKQGFwcC5wb3N0KCIvYXBpL2F1dGgvbG9naW4iLCByZXNwb25zZV9tb2RlbD1Mb2dpblJlc3BvbnNlKQpkZWYgbG9naW4ocmVxOiBMb2dpblJlcXVlc3QsIHJlcXVlc3Q6IFJlcXVlc3QpOgogICAgX2NoZWNrX3JhdGVfbGltaXQocmVxdWVzdC5jbGllbnQuaG9zdCBpZiByZXF1ZXN0LmNsaWVudCBlbHNlICJ1bmtub3duIikKICAgIHdpdGggZ2V0X2RiKCkgYXMgY29ubjoKICAgICAgICB3aXRoIGNvbm4uY3Vyc29yKCkgYXMgY3VyOgogICAgICAgICAgICBjdXIuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICJTRUxFQ1QgaWQsIHVzZXJuYW1lLCBwYXNzd29yZCwgcm9sZSwgZGlzcGxheV9uYW1lLCBpc19hY3RpdmUgRlJPTSB1c2VycyBXSEVSRSB1c2VybmFtZSA9ICVzIiwKICAgICAgICAgICAgICAgIChyZXEudXNlcm5hbWUsKSwKICAgICAgICAgICAgKQogICAgICAgICAgICB1c2VyID0gY3VyLmZldGNob25lKCkKCiAgICBpZiBub3QgdXNlcjoKICAgICAgICByYWlzZSBIVFRQRXhjZXB0aW9uKHN0YXR1c19jb2RlPTQwMSwgZGV0YWlsPSLsgqzsmqnsnpDrpbwg7LC+7J2EIOyImCDsl4bsirXri4jri6QiKQogICAgaWYgbm90IHVzZXJbImlzX2FjdGl2ZSJdOgogICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24oc3RhdHVzX2NvZGU9NDAxLCBkZXRhaWw9Iuu5hO2ZnOyEse2ZlOuQnCDqs4TsoJXsnoXri4jri6QiKQogICAgaWYgbm90IHZlcmlmeV9wYXNzd29yZChyZXEucGFzc3dvcmQsIHVzZXJbInBhc3N3b3JkIl0pOgogICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24oc3RhdHVzX2NvZGU9NDAxLCBkZXRhaWw9Iuu5hOuwgOuyiO2YuOqwgCDsmKzrsJTrpbTsp4Ag7JWK7Iq164uI64ukIikKCiAgICB3aXRoIGdldF9kYigpIGFzIGNvbm46CiAgICAgICAgd2l0aCBjb25uLmN1cnNvcigpIGFzIGN1cjoKICAgICAgICAgICAgY3VyLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiVVBEQVRFIHVzZXJzIFNFVCBsYXN0X2xvZ2luID0gJXMgV0hFUkUgaWQgPSAlcyIsCiAgICAgICAgICAgICAgICAoZGF0ZXRpbWUubm93KHRpbWV6b25lLnV0YyksIHVzZXJbImlkIl0pLAogICAgICAgICAgICApCgogICAgdG9rZW4gPSBjcmVhdGVfdG9rZW4odXNlclsiaWQiXSwgdXNlclsidXNlcm5hbWUiXSwgdXNlclsicm9sZSJdKQogICAgcmV0dXJuIExvZ2luUmVzcG9uc2UoCiAgICAgICAgdG9rZW49dG9rZW4sCiAgICAgICAgdXNlcj1Vc2VySW5mbygKICAgICAgICAgICAgaWQ9dXNlclsiaWQiXSwKICAgICAgICAgICAgdXNlcm5hbWU9dXNlclsidXNlcm5hbWUiXSwKICAgICAgICAgICAgcm9sZT11c2VyWyJyb2xlIl0sCiAgICAgICAgICAgIGRpc3BsYXlfbmFtZT11c2VyWyJkaXNwbGF5X25hbWUiXSwKICAgICAgICApLAogICAgKQoKCkBhcHAuZ2V0KCIvYXBpL2F1dGgvbWUiLCByZXNwb25zZV9tb2RlbD1Vc2VySW5mbykKZGVmIGdldF9tZSh1c2VyOiBkaWN0ID0gRGVwZW5kcyhnZXRfY3VycmVudF91c2VyKSk6CiAgICByZXR1cm4gVXNlckluZm8oCiAgICAgICAgaWQ9dXNlclsiaWQiXSwKICAgICAgICB1c2VybmFtZT11c2VyWyJ1c2VybmFtZSJdLAogICAgICAgIHJvbGU9dXNlclsicm9sZSJdLAogICAgICAgIGRpc3BsYXlfbmFtZT11c2VyWyJkaXNwbGF5X25hbWUiXSwKICAgICkKCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgQWdlbnQg65Ox66GdL+q0gOumrCAo7JeQ7J207KCE7Yq4IOKGkiDshJzrsoQpCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KQGFwcC5wb3N0KCIvYXBpL2FnZW50cy9yZWdpc3RlciIsIHJlc3BvbnNlX21vZGVsPUFnZW50UmVzcG9uc2UpCmRlZiByZWdpc3Rlcl9hZ2VudChyZXE6IEFnZW50UmVnaXN0ZXIsIHVzZXI6IGRpY3QgPSBEZXBlbmRzKGdldF9jdXJyZW50X3VzZXIpKToKICAgICIiIuyXkOydtOyghO2KuOqwgCDshJzrsoTsl5Ag7J6Q7Iug7J2EIOuTseuhnSAo66Gc6re47J247ZWcIOyCrOyaqeyekOydmCDshozsnKDroZwpIiIiCiAgICB3aXRoIGdldF9kYigpIGFzIGNvbm46CiAgICAgICAgd2l0aCBjb25uLmN1cnNvcigpIGFzIGN1cjoKICAgICAgICAgICAgIyDsnbTrr7gg65Ox66Gd65CcIOyXkOydtOyghO2KuOyduOyngCDtmZXsnbgKICAgICAgICAgICAgY3VyLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiU0VMRUNUIGlkIEZST00gYWdlbnRzIFdIRVJFIGFnZW50X2lkID0gJXMgQU5EIG93bmVyX2lkID0gJXMiLAogICAgICAgICAgICAgICAgKHJlcS5hZ2VudF9pZCwgdXNlclsiaWQiXSksCiAgICAgICAgICAgICkKICAgICAgICAgICAgZXhpc3RpbmcgPSBjdXIuZmV0Y2hvbmUoKQoKICAgICAgICAgICAgbm93ID0gZGF0ZXRpbWUubm93KHRpbWV6b25lLnV0YykKCiAgICAgICAgICAgIGlmIGV4aXN0aW5nOgogICAgICAgICAgICAgICAgIyDquLDsobQg7JeQ7J207KCE7Yq4IOyXheuNsOydtO2KuAogICAgICAgICAgICAgICAgY3VyLmV4ZWN1dGUoIiIiCiAgICAgICAgICAgICAgICAgICAgVVBEQVRFIGFnZW50cyBTRVQKICAgICAgICAgICAgICAgICAgICAgICAgaG9zdG5hbWUgPSAlcywgb3NfaW5mbyA9ICVzLCBpcCA9ICVzLAogICAgICAgICAgICAgICAgICAgICAgICBpcF9wdWJsaWMgPSAlcywgd3NfcG9ydCA9ICVzLAogICAgICAgICAgICAgICAgICAgICAgICBtYWNfYWRkcmVzcyA9ICVzLCBzY3JlZW5fd2lkdGggPSAlcywgc2NyZWVuX2hlaWdodCA9ICVzLAogICAgICAgICAgICAgICAgICAgICAgICBhZ2VudF92ZXJzaW9uID0gJXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGNwdV9tb2RlbCA9ICVzLCBjcHVfY29yZXMgPSAlcywgcmFtX2diID0gJXMsCiAgICAgICAgICAgICAgICAgICAgICAgIG1vdGhlcmJvYXJkID0gJXMsIGdwdV9tb2RlbCA9ICVzLAogICAgICAgICAgICAgICAgICAgICAgICBpc19vbmxpbmUgPSBUUlVFLCBsYXN0X3NlZW4gPSAlcwogICAgICAgICAgICAgICAgICAgIFdIRVJFIGlkID0gJXMKICAgICAgICAgICAgICAgICIiIiwgKAogICAgICAgICAgICAgICAgICAgIHJlcS5ob3N0bmFtZSwgcmVxLm9zX2luZm8sIHJlcS5pcCwKICAgICAgICAgICAgICAgICAgICByZXEuaXBfcHVibGljLCByZXEud3NfcG9ydCwKICAgICAgICAgICAgICAgICAgICByZXEubWFjX2FkZHJlc3MsIHJlcS5zY3JlZW5fd2lkdGgsIHJlcS5zY3JlZW5faGVpZ2h0LAogICAgICAgICAgICAgICAgICAgIHJlcS5hZ2VudF92ZXJzaW9uLAogICAgICAgICAgICAgICAgICAgIHJlcS5jcHVfbW9kZWwsIHJlcS5jcHVfY29yZXMsIHJlcS5yYW1fZ2IsCiAgICAgICAgICAgICAgICAgICAgcmVxLm1vdGhlcmJvYXJkLCByZXEuZ3B1X21vZGVsLAogICAgICAgICAgICAgICAgICAgIG5vdywgZXhpc3RpbmdbImlkIl0sCiAgICAgICAgICAgICAgICApKQogICAgICAgICAgICAgICAgYWdlbnRfaWRfZGIgPSBleGlzdGluZ1siaWQiXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyDsi6Dqt5wg65Ox66GdCiAgICAgICAgICAgICAgICBjdXIuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgICAgICAgICBJTlNFUlQgSU5UTyBhZ2VudHMKICAgICAgICAgICAgICAgICAgICAgICAgKGFnZW50X2lkLCBvd25lcl9pZCwgaG9zdG5hbWUsIG9zX2luZm8sIGlwLAogICAgICAgICAgICAgICAgICAgICAgICAgaXBfcHVibGljLCB3c19wb3J0LAogICAgICAgICAgICAgICAgICAgICAgICAgbWFjX2FkZHJlc3MsIHNjcmVlbl93aWR0aCwgc2NyZWVuX2hlaWdodCwKICAgICAgICAgICAgICAgICAgICAgICAgIGFnZW50X3ZlcnNpb24sCiAgICAgICAgICAgICAgICAgICAgICAgICBjcHVfbW9kZWwsIGNwdV9jb3JlcywgcmFtX2diLCBtb3RoZXJib2FyZCwgZ3B1X21vZGVsLAogICAgICAgICAgICAgICAgICAgICAgICAgaXNfb25saW5lLCBsYXN0X3NlZW4pCiAgICAgICAgICAgICAgICAgICAgVkFMVUVTICglcywgJXMsICVzLCAlcywgJXMsICVzLCAlcywgJXMsICVzLCAlcywgJXMsICVzLCAlcywgJXMsICVzLCAlcywgVFJVRSwgJXMpCiAgICAgICAgICAgICAgICAiIiIsICgKICAgICAgICAgICAgICAgICAgICByZXEuYWdlbnRfaWQsIHVzZXJbImlkIl0sCiAgICAgICAgICAgICAgICAgICAgcmVxLmhvc3RuYW1lLCByZXEub3NfaW5mbywgcmVxLmlwLAogICAgICAgICAgICAgICAgICAgIHJlcS5pcF9wdWJsaWMsIHJlcS53c19wb3J0LAogICAgICAgICAgICAgICAgICAgIHJlcS5tYWNfYWRkcmVzcywgcmVxLnNjcmVlbl93aWR0aCwgcmVxLnNjcmVlbl9oZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgcmVxLmFnZW50X3ZlcnNpb24sCiAgICAgICAgICAgICAgICAgICAgcmVxLmNwdV9tb2RlbCwgcmVxLmNwdV9jb3JlcywgcmVxLnJhbV9nYiwKICAgICAgICAgICAgICAgICAgICByZXEubW90aGVyYm9hcmQsIHJlcS5ncHVfbW9kZWwsCiAgICAgICAgICAgICAgICAgICAgbm93LAogICAgICAgICAgICAgICAgKSkKICAgICAgICAgICAgICAgIGFnZW50X2lkX2RiID0gY3VyLmxhc3Ryb3dpZAoKICAgICAgICAgICAgIyDrk7HroZ3rkJwg7JeQ7J207KCE7Yq4IOuwmO2ZmAogICAgICAgICAgICBjdXIuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgICAgIFNFTEVDVCBhLiosIHUudXNlcm5hbWUgYXMgb3duZXJfdXNlcm5hbWUKICAgICAgICAgICAgICAgIEZST00gYWdlbnRzIGEgSk9JTiB1c2VycyB1IE9OIGEub3duZXJfaWQgPSB1LmlkCiAgICAgICAgICAgICAgICBXSEVSRSBhLmlkID0gJXMKICAgICAgICAgICAgIiIiLCAoYWdlbnRfaWRfZGIsKSkKICAgICAgICAgICAgYWdlbnQgPSBjdXIuZmV0Y2hvbmUoKQoKICAgIHJldHVybiBfYWdlbnRfdG9fcmVzcG9uc2UoYWdlbnQpCgoKQGFwcC5wb3N0KCIvYXBpL2FnZW50cy9oZWFydGJlYXQiKQpkZWYgYWdlbnRfaGVhcnRiZWF0KHJlcTogQWdlbnRIZWFydGJlYXQsIHVzZXI6IGRpY3QgPSBEZXBlbmRzKGdldF9jdXJyZW50X3VzZXIpKToKICAgICIiIuyXkOydtOyghO2KuCDtlZjtirjruYTtirggKOyjvOq4sOyggSDsg4Htg5wg67O06rOgKSIiIgogICAgd2l0aCBnZXRfZGIoKSBhcyBjb25uOgogICAgICAgIHdpdGggY29ubi5jdXJzb3IoKSBhcyBjdXI6CiAgICAgICAgICAgIGN1ci5leGVjdXRlKCIiIgogICAgICAgICAgICAgICAgVVBEQVRFIGFnZW50cyBTRVQKICAgICAgICAgICAgICAgICAgICBpc19vbmxpbmUgPSBUUlVFLCBsYXN0X3NlZW4gPSAlcywgaXAgPSAlcywKICAgICAgICAgICAgICAgICAgICBpcF9wdWJsaWMgPSAlcywgd3NfcG9ydCA9ICVzLAogICAgICAgICAgICAgICAgICAgIHNjcmVlbl93aWR0aCA9ICVzLCBzY3JlZW5faGVpZ2h0ID0gJXMsCiAgICAgICAgICAgICAgICAgICAgYWdlbnRfdmVyc2lvbiA9ICVzCiAgICAgICAgICAgICAgICBXSEVSRSBhZ2VudF9pZCA9ICVzIEFORCBvd25lcl9pZCA9ICVzCiAgICAgICAgICAgICIiIiwgKAogICAgICAgICAgICAgICAgZGF0ZXRpbWUubm93KHRpbWV6b25lLnV0YyksIHJlcS5pcCwKICAgICAgICAgICAgICAgIHJlcS5pcF9wdWJsaWMsIHJlcS53c19wb3J0LAogICAgICAgICAgICAgICAgcmVxLnNjcmVlbl93aWR0aCwgcmVxLnNjcmVlbl9oZWlnaHQsCiAgICAgICAgICAgICAgICByZXEuYWdlbnRfdmVyc2lvbiwKICAgICAgICAgICAgICAgIHJlcS5hZ2VudF9pZCwgdXNlclsiaWQiXSwKICAgICAgICAgICAgKSkKICAgIHJldHVybiB7InN0YXR1cyI6ICJvayJ9CgoKQGFwcC5wb3N0KCIvYXBpL2FnZW50cy9vZmZsaW5lIikKZGVmIGFnZW50X29mZmxpbmUocmVxOiBBZ2VudEhlYXJ0YmVhdCwgdXNlcjogZGljdCA9IERlcGVuZHMoZ2V0X2N1cnJlbnRfdXNlcikpOgogICAgIiIi7JeQ7J207KCE7Yq4IOyYpO2UhOudvOyduCDrs7Tqs6AgKOygleyDgSDsooXro4wg7IucKSIiIgogICAgd2l0aCBnZXRfZGIoKSBhcyBjb25uOgogICAgICAgIHdpdGggY29ubi5jdXJzb3IoKSBhcyBjdXI6CiAgICAgICAgICAgIGN1ci5leGVjdXRlKAogICAgICAgICAgICAgICAgIlVQREFURSBhZ2VudHMgU0VUIGlzX29ubGluZSA9IEZBTFNFIFdIRVJFIGFnZW50X2lkID0gJXMgQU5EIG93bmVyX2lkID0gJXMiLAogICAgICAgICAgICAgICAgKHJlcS5hZ2VudF9pZCwgdXNlclsiaWQiXSksCiAgICAgICAgICAgICkKICAgIHJldHVybiB7InN0YXR1cyI6ICJvayJ9CgoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIEFnZW50IOyhsO2ajCAo66ek64uI7KCAIOKGkiDshJzrsoQpCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KQGFwcC5nZXQoIi9hcGkvYWdlbnRzIiwgcmVzcG9uc2VfbW9kZWw9bGlzdFtBZ2VudFJlc3BvbnNlXSkKZGVmIGdldF9teV9hZ2VudHModXNlcjogZGljdCA9IERlcGVuZHMoZ2V0X2N1cnJlbnRfdXNlcikpOgogICAgIiIi66Gc6re47J247ZWcIOyCrOyaqeyekCDshozsnKDsnZgg7JeQ7J207KCE7Yq4IOuqqeuhnSIiIgogICAgd2l0aCBnZXRfZGIoKSBhcyBjb25uOgogICAgICAgIHdpdGggY29ubi5jdXJzb3IoKSBhcyBjdXI6CiAgICAgICAgICAgIGlmIHVzZXJbInJvbGUiXSA9PSAiYWRtaW4iOgogICAgICAgICAgICAgICAgIyDqtIDrpqzsnpA6IOyghOyytCDsl5DsnbTsoITtirgKICAgICAgICAgICAgICAgIGN1ci5leGVjdXRlKCIiIgogICAgICAgICAgICAgICAgICAgIFNFTEVDVCBhLiosIHUudXNlcm5hbWUgYXMgb3duZXJfdXNlcm5hbWUKICAgICAgICAgICAgICAgICAgICBGUk9NIGFnZW50cyBhIEpPSU4gdXNlcnMgdSBPTiBhLm93bmVyX2lkID0gdS5pZAogICAgICAgICAgICAgICAgICAgIE9SREVSIEJZIGEuZ3JvdXBfbmFtZSwgYS5ob3N0bmFtZQogICAgICAgICAgICAgICAgIiIiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyDsnbzrsJgg7IKs7Jqp7J6QOiDsnpDquLAg7IaM7Jyg66eMCiAgICAgICAgICAgICAgICBjdXIuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgICAgICAgICBTRUxFQ1QgYS4qLCB1LnVzZXJuYW1lIGFzIG93bmVyX3VzZXJuYW1lCiAgICAgICAgICAgICAgICAgICAgRlJPTSBhZ2VudHMgYSBKT0lOIHVzZXJzIHUgT04gYS5vd25lcl9pZCA9IHUuaWQKICAgICAgICAgICAgICAgICAgICBXSEVSRSBhLm93bmVyX2lkID0gJXMKICAgICAgICAgICAgICAgICAgICBPUkRFUiBCWSBhLmdyb3VwX25hbWUsIGEuaG9zdG5hbWUKICAgICAgICAgICAgICAgICIiIiwgKHVzZXJbImlkIl0sKSkKICAgICAgICAgICAgYWdlbnRzID0gY3VyLmZldGNoYWxsKCkKCiAgICByZXR1cm4gW19hZ2VudF90b19yZXNwb25zZShhKSBmb3IgYSBpbiBhZ2VudHNdCgoKQGFwcC5nZXQoIi9hcGkvYWdlbnRzL3thZ2VudF9kYl9pZH0iLCByZXNwb25zZV9tb2RlbD1BZ2VudFJlc3BvbnNlKQpkZWYgZ2V0X2FnZW50KGFnZW50X2RiX2lkOiBpbnQsIHVzZXI6IGRpY3QgPSBEZXBlbmRzKGdldF9jdXJyZW50X3VzZXIpKToKICAgICIiIu2KueyglSDsl5DsnbTsoITtirgg7KGw7ZqMIiIiCiAgICB3aXRoIGdldF9kYigpIGFzIGNvbm46CiAgICAgICAgd2l0aCBjb25uLmN1cnNvcigpIGFzIGN1cjoKICAgICAgICAgICAgY3VyLmV4ZWN1dGUoIiIiCiAgICAgICAgICAgICAgICBTRUxFQ1QgYS4qLCB1LnVzZXJuYW1lIGFzIG93bmVyX3VzZXJuYW1lCiAgICAgICAgICAgICAgICBGUk9NIGFnZW50cyBhIEpPSU4gdXNlcnMgdSBPTiBhLm93bmVyX2lkID0gdS5pZAogICAgICAgICAgICAgICAgV0hFUkUgYS5pZCA9ICVzCiAgICAgICAgICAgICIiIiwgKGFnZW50X2RiX2lkLCkpCiAgICAgICAgICAgIGFnZW50ID0gY3VyLmZldGNob25lKCkKCiAgICBpZiBub3QgYWdlbnQ6CiAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihzdGF0dXNfY29kZT00MDQsIGRldGFpbD0i7JeQ7J207KCE7Yq466W8IOywvuydhCDsiJgg7JeG7Iq164uI64ukIikKICAgIGlmIHVzZXJbInJvbGUiXSAhPSAiYWRtaW4iIGFuZCBhZ2VudFsib3duZXJfaWQiXSAhPSB1c2VyWyJpZCJdOgogICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24oc3RhdHVzX2NvZGU9NDAzLCBkZXRhaWw9Iuygkeq3vCDqtoztlZzsnbQg7JeG7Iq164uI64ukIikKCiAgICByZXR1cm4gX2FnZW50X3RvX3Jlc3BvbnNlKGFnZW50KQoKCkBhcHAuZGVsZXRlKCIvYXBpL2FnZW50cy97YWdlbnRfZGJfaWR9IikKZGVmIGRlbGV0ZV9hZ2VudChhZ2VudF9kYl9pZDogaW50LCB1c2VyOiBkaWN0ID0gRGVwZW5kcyhnZXRfY3VycmVudF91c2VyKSk6CiAgICAiIiLsl5DsnbTsoITtirgg7IKt7KCcIiIiCiAgICB3aXRoIGdldF9kYigpIGFzIGNvbm46CiAgICAgICAgd2l0aCBjb25uLmN1cnNvcigpIGFzIGN1cjoKICAgICAgICAgICAgY3VyLmV4ZWN1dGUoIlNFTEVDVCBvd25lcl9pZCBGUk9NIGFnZW50cyBXSEVSRSBpZCA9ICVzIiwgKGFnZW50X2RiX2lkLCkpCiAgICAgICAgICAgIGFnZW50ID0gY3VyLmZldGNob25lKCkKICAgICAgICAgICAgaWYgbm90IGFnZW50OgogICAgICAgICAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihzdGF0dXNfY29kZT00MDQpCiAgICAgICAgICAgIGlmIHVzZXJbInJvbGUiXSAhPSAiYWRtaW4iIGFuZCBhZ2VudFsib3duZXJfaWQiXSAhPSB1c2VyWyJpZCJdOgogICAgICAgICAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihzdGF0dXNfY29kZT00MDMpCiAgICAgICAgICAgIGN1ci5leGVjdXRlKCJERUxFVEUgRlJPTSBhZ2VudHMgV0hFUkUgaWQgPSAlcyIsIChhZ2VudF9kYl9pZCwpKQogICAgcmV0dXJuIHsic3RhdHVzIjogImRlbGV0ZWQifQoKCkBhcHAucHV0KCIvYXBpL2FnZW50cy97YWdlbnRfZGJfaWR9L2dyb3VwIikKZGVmIG1vdmVfYWdlbnRfZ3JvdXAoYWdlbnRfZGJfaWQ6IGludCwgZ3JvdXBfbmFtZTogc3RyID0gUXVlcnkoLi4uKSwKICAgICAgICAgICAgICAgICAgICAgdXNlcjogZGljdCA9IERlcGVuZHMoZ2V0X2N1cnJlbnRfdXNlcikpOgogICAgIiIi7JeQ7J207KCE7Yq4IOq3uOujuSDsnbTrj5kiIiIKICAgIHdpdGggZ2V0X2RiKCkgYXMgY29ubjoKICAgICAgICB3aXRoIGNvbm4uY3Vyc29yKCkgYXMgY3VyOgogICAgICAgICAgICBjdXIuZXhlY3V0ZSgiU0VMRUNUIG93bmVyX2lkIEZST00gYWdlbnRzIFdIRVJFIGlkID0gJXMiLCAoYWdlbnRfZGJfaWQsKSkKICAgICAgICAgICAgYWdlbnQgPSBjdXIuZmV0Y2hvbmUoKQogICAgICAgICAgICBpZiBub3QgYWdlbnQ6CiAgICAgICAgICAgICAgICByYWlzZSBIVFRQRXhjZXB0aW9uKHN0YXR1c19jb2RlPTQwNCkKICAgICAgICAgICAgaWYgdXNlclsicm9sZSJdICE9ICJhZG1pbiIgYW5kIGFnZW50WyJvd25lcl9pZCJdICE9IHVzZXJbImlkIl06CiAgICAgICAgICAgICAgICByYWlzZSBIVFRQRXhjZXB0aW9uKHN0YXR1c19jb2RlPTQwMykKICAgICAgICAgICAgY3VyLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiVVBEQVRFIGFnZW50cyBTRVQgZ3JvdXBfbmFtZSA9ICVzIFdIRVJFIGlkID0gJXMiLAogICAgICAgICAgICAgICAgKGdyb3VwX25hbWUsIGFnZW50X2RiX2lkKSwKICAgICAgICAgICAgKQogICAgcmV0dXJuIHsic3RhdHVzIjogIm9rIn0KCgpAYXBwLnB1dCgiL2FwaS9hZ2VudHMve2FnZW50X2RiX2lkfS9uYW1lIikKZGVmIHJlbmFtZV9hZ2VudChhZ2VudF9kYl9pZDogaW50LCBkaXNwbGF5X25hbWU6IHN0ciA9IFF1ZXJ5KC4uLiksCiAgICAgICAgICAgICAgICAgdXNlcjogZGljdCA9IERlcGVuZHMoZ2V0X2N1cnJlbnRfdXNlcikpOgogICAgIiIi7JeQ7J207KCE7Yq4IO2RnOyLnCDsnbTrpoQg67OA6rK9IiIiCiAgICB3aXRoIGdldF9kYigpIGFzIGNvbm46CiAgICAgICAgd2l0aCBjb25uLmN1cnNvcigpIGFzIGN1cjoKICAgICAgICAgICAgY3VyLmV4ZWN1dGUoIlNFTEVDVCBvd25lcl9pZCBGUk9NIGFnZW50cyBXSEVSRSBpZCA9ICVzIiwgKGFnZW50X2RiX2lkLCkpCiAgICAgICAgICAgIGFnZW50ID0gY3VyLmZldGNob25lKCkKICAgICAgICAgICAgaWYgbm90IGFnZW50OgogICAgICAgICAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihzdGF0dXNfY29kZT00MDQpCiAgICAgICAgICAgIGlmIHVzZXJbInJvbGUiXSAhPSAiYWRtaW4iIGFuZCBhZ2VudFsib3duZXJfaWQiXSAhPSB1c2VyWyJpZCJdOgogICAgICAgICAgICAgICAgcmFpc2UgSFRUUEV4Y2VwdGlvbihzdGF0dXNfY29kZT00MDMpCiAgICAgICAgICAgIGN1ci5leGVjdXRlKAogICAgICAgICAgICAgICAgIlVQREFURSBhZ2VudHMgU0VUIGRpc3BsYXlfbmFtZSA9ICVzIFdIRVJFIGlkID0gJXMiLAogICAgICAgICAgICAgICAgKGRpc3BsYXlfbmFtZSwgYWdlbnRfZGJfaWQpLAogICAgICAgICAgICApCiAgICByZXR1cm4geyJzdGF0dXMiOiAib2sifQoKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBVc2VyIOq0gOumrCAoQWRtaW4pCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KQGFwcC5wb3N0KCIvYXBpL2FkbWluL3VzZXJzIiwgcmVzcG9uc2VfbW9kZWw9VXNlclJlc3BvbnNlKQpkZWYgY3JlYXRlX3VzZXIocmVxOiBVc2VyQ3JlYXRlLCBhZG1pbjogZGljdCA9IERlcGVuZHMocmVxdWlyZV9hZG1pbikpOgogICAgd2l0aCBnZXRfZGIoKSBhcyBjb25uOgogICAgICAgIHdpdGggY29ubi5jdXJzb3IoKSBhcyBjdXI6CiAgICAgICAgICAgIGhhc2hlZCA9IGhhc2hfcGFzc3dvcmQocmVxLnBhc3N3b3JkKQogICAgICAgICAgICBjdXIuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgICAgIElOU0VSVCBJTlRPIHVzZXJzICh1c2VybmFtZSwgcGFzc3dvcmQsIHJvbGUsIGRpc3BsYXlfbmFtZSkKICAgICAgICAgICAgICAgIFZBTFVFUyAoJXMsICVzLCAlcywgJXMpCiAgICAgICAgICAgICIiIiwgKHJlcS51c2VybmFtZSwgaGFzaGVkLCByZXEucm9sZSwgcmVxLmRpc3BsYXlfbmFtZSkpCiAgICAgICAgICAgIHVzZXJfaWQgPSBjdXIubGFzdHJvd2lkCiAgICAgICAgICAgIGN1ci5leGVjdXRlKCJTRUxFQ1QgKiBGUk9NIHVzZXJzIFdIRVJFIGlkID0gJXMiLCAodXNlcl9pZCwpKQogICAgICAgICAgICB1c2VyID0gY3VyLmZldGNob25lKCkKICAgIHJldHVybiBfdXNlcl90b19yZXNwb25zZSh1c2VyKQoKCkBhcHAuZ2V0KCIvYXBpL2FkbWluL3VzZXJzIiwgcmVzcG9uc2VfbW9kZWw9bGlzdFtVc2VyUmVzcG9uc2VdKQpkZWYgbGlzdF91c2VycyhhZG1pbjogZGljdCA9IERlcGVuZHMocmVxdWlyZV9hZG1pbikpOgogICAgd2l0aCBnZXRfZGIoKSBhcyBjb25uOgogICAgICAgIHdpdGggY29ubi5jdXJzb3IoKSBhcyBjdXI6CiAgICAgICAgICAgIGN1ci5leGVjdXRlKCJTRUxFQ1QgKiBGUk9NIHVzZXJzIE9SREVSIEJZIGlkIikKICAgICAgICAgICAgdXNlcnMgPSBjdXIuZmV0Y2hhbGwoKQogICAgcmV0dXJuIFtfdXNlcl90b19yZXNwb25zZSh1KSBmb3IgdSBpbiB1c2Vyc10KCgpAYXBwLnB1dCgiL2FwaS9hZG1pbi91c2Vycy97dXNlcl9pZH0iLCByZXNwb25zZV9tb2RlbD1Vc2VyUmVzcG9uc2UpCmRlZiB1cGRhdGVfdXNlcih1c2VyX2lkOiBpbnQsIHJlcTogVXNlclVwZGF0ZSwgYWRtaW46IGRpY3QgPSBEZXBlbmRzKHJlcXVpcmVfYWRtaW4pKToKICAgIHdpdGggZ2V0X2RiKCkgYXMgY29ubjoKICAgICAgICB3aXRoIGNvbm4uY3Vyc29yKCkgYXMgY3VyOgogICAgICAgICAgICB1cGRhdGVzID0ge30KICAgICAgICAgICAgaWYgcmVxLmRpc3BsYXlfbmFtZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHVwZGF0ZXNbImRpc3BsYXlfbmFtZSJdID0gcmVxLmRpc3BsYXlfbmFtZQogICAgICAgICAgICBpZiByZXEucm9sZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHVwZGF0ZXNbInJvbGUiXSA9IHJlcS5yb2xlCiAgICAgICAgICAgIGlmIHJlcS5pc19hY3RpdmUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICB1cGRhdGVzWyJpc19hY3RpdmUiXSA9IHJlcS5pc19hY3RpdmUKICAgICAgICAgICAgaWYgcmVxLnBhc3N3b3JkIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdXBkYXRlc1sicGFzc3dvcmQiXSA9IGhhc2hfcGFzc3dvcmQocmVxLnBhc3N3b3JkKQoKICAgICAgICAgICAgaWYgdXBkYXRlczoKICAgICAgICAgICAgICAgIHNldF9jbGF1c2UgPSAiLCAiLmpvaW4oZiJ7a30gPSAlcyIgZm9yIGsgaW4gdXBkYXRlcykKICAgICAgICAgICAgICAgIHZhbHVlcyA9IGxpc3QodXBkYXRlcy52YWx1ZXMoKSkgKyBbdXNlcl9pZF0KICAgICAgICAgICAgICAgIGN1ci5leGVjdXRlKGYiVVBEQVRFIHVzZXJzIFNFVCB7c2V0X2NsYXVzZX0gV0hFUkUgaWQgPSAlcyIsIHZhbHVlcykKCiAgICAgICAgICAgIGN1ci5leGVjdXRlKCJTRUxFQ1QgKiBGUk9NIHVzZXJzIFdIRVJFIGlkID0gJXMiLCAodXNlcl9pZCwpKQogICAgICAgICAgICB1c2VyID0gY3VyLmZldGNob25lKCkKICAgIGlmIG5vdCB1c2VyOgogICAgICAgIHJhaXNlIEhUVFBFeGNlcHRpb24oc3RhdHVzX2NvZGU9NDA0KQogICAgcmV0dXJuIF91c2VyX3RvX3Jlc3BvbnNlKHVzZXIpCgoKQGFwcC5kZWxldGUoIi9hcGkvYWRtaW4vdXNlcnMve3VzZXJfaWR9IikKZGVmIGRlbGV0ZV91c2VyKHVzZXJfaWQ6IGludCwgYWRtaW46IGRpY3QgPSBEZXBlbmRzKHJlcXVpcmVfYWRtaW4pKToKICAgIHdpdGggZ2V0X2RiKCkgYXMgY29ubjoKICAgICAgICB3aXRoIGNvbm4uY3Vyc29yKCkgYXMgY3VyOgogICAgICAgICAgICBjdXIuZXhlY3V0ZSgiREVMRVRFIEZST00gdXNlcnMgV0hFUkUgaWQgPSAlcyBBTkQgdXNlcm5hbWUgIT0gJ2FkbWluJyIsICh1c2VyX2lkLCkpCiAgICByZXR1cm4geyJzdGF0dXMiOiAiZGVsZXRlZCJ9CgoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIEhlbHBlcnMKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpkZWYgX2FnZW50X3RvX3Jlc3BvbnNlKGFnZW50OiBkaWN0KSAtPiBBZ2VudFJlc3BvbnNlOgogICAgcmV0dXJuIEFnZW50UmVzcG9uc2UoCiAgICAgICAgaWQ9YWdlbnRbImlkIl0sCiAgICAgICAgYWdlbnRfaWQ9YWdlbnRbImFnZW50X2lkIl0sCiAgICAgICAgaG9zdG5hbWU9YWdlbnRbImhvc3RuYW1lIl0sCiAgICAgICAgb3NfaW5mbz1hZ2VudC5nZXQoIm9zX2luZm8iLCAiIiksCiAgICAgICAgaXA9YWdlbnQuZ2V0KCJpcCIsICIiKSwKICAgICAgICBpcF9wdWJsaWM9YWdlbnQuZ2V0KCJpcF9wdWJsaWMiLCAiIiksCiAgICAgICAgd3NfcG9ydD1hZ2VudC5nZXQoIndzX3BvcnQiLCAyMTM1MCksCiAgICAgICAgbWFjX2FkZHJlc3M9YWdlbnQuZ2V0KCJtYWNfYWRkcmVzcyIsICIiKSwKICAgICAgICBzY3JlZW5fd2lkdGg9YWdlbnQuZ2V0KCJzY3JlZW5fd2lkdGgiLCAxOTIwKSwKICAgICAgICBzY3JlZW5faGVpZ2h0PWFnZW50LmdldCgic2NyZWVuX2hlaWdodCIsIDEwODApLAogICAgICAgIGdyb3VwX25hbWU9YWdlbnQuZ2V0KCJncm91cF9uYW1lIiwgImRlZmF1bHQiKSwKICAgICAgICBkaXNwbGF5X25hbWU9YWdlbnQuZ2V0KCJkaXNwbGF5X25hbWUiKSwKICAgICAgICBpc19vbmxpbmU9Ym9vbChhZ2VudC5nZXQoImlzX29ubGluZSIsIEZhbHNlKSksCiAgICAgICAgb3duZXJfaWQ9YWdlbnRbIm93bmVyX2lkIl0sCiAgICAgICAgb3duZXJfdXNlcm5hbWU9YWdlbnQuZ2V0KCJvd25lcl91c2VybmFtZSIsICIiKSwKICAgICAgICBsYXN0X3NlZW49c3RyKGFnZW50WyJsYXN0X3NlZW4iXSkgaWYgYWdlbnQuZ2V0KCJsYXN0X3NlZW4iKSBlbHNlIE5vbmUsCiAgICAgICAgYWdlbnRfdmVyc2lvbj1hZ2VudC5nZXQoImFnZW50X3ZlcnNpb24iLCAiIiksCiAgICAgICAgY3B1X21vZGVsPWFnZW50LmdldCgiY3B1X21vZGVsIiwgIiIpLAogICAgICAgIGNwdV9jb3Jlcz1hZ2VudC5nZXQoImNwdV9jb3JlcyIsIDApLAogICAgICAgIHJhbV9nYj1hZ2VudC5nZXQoInJhbV9nYiIsIDAuMCksCiAgICAgICAgbW90aGVyYm9hcmQ9YWdlbnQuZ2V0KCJtb3RoZXJib2FyZCIsICIiKSwKICAgICAgICBncHVfbW9kZWw9YWdlbnQuZ2V0KCJncHVfbW9kZWwiLCAiIiksCiAgICApCgoKZGVmIF91c2VyX3RvX3Jlc3BvbnNlKHVzZXI6IGRpY3QpIC0+IFVzZXJSZXNwb25zZToKICAgIHJldHVybiBVc2VyUmVzcG9uc2UoCiAgICAgICAgaWQ9dXNlclsiaWQiXSwKICAgICAgICB1c2VybmFtZT11c2VyWyJ1c2VybmFtZSJdLAogICAgICAgIHJvbGU9dXNlclsicm9sZSJdLAogICAgICAgIGRpc3BsYXlfbmFtZT11c2VyLmdldCgiZGlzcGxheV9uYW1lIiksCiAgICAgICAgaXNfYWN0aXZlPWJvb2wodXNlci5nZXQoImlzX2FjdGl2ZSIsIFRydWUpKSwKICAgICAgICBjcmVhdGVkX2F0PXN0cih1c2VyWyJjcmVhdGVkX2F0Il0pIGlmIHVzZXIuZ2V0KCJjcmVhdGVkX2F0IikgZWxzZSBOb25lLAogICAgICAgIGxhc3RfbG9naW49c3RyKHVzZXJbImxhc3RfbG9naW4iXSkgaWYgdXNlci5nZXQoImxhc3RfbG9naW4iKSBlbHNlIE5vbmUsCiAgICApCgoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIOyLpO2WiQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICBpbXBvcnQgdXZpY29ybgogICAgZnJvbSBjb25maWcgaW1wb3J0IEFQSV9IT1NULCBBUElfUE9SVAogICAgdXZpY29ybi5ydW4oYXBwLCBob3N0PUFQSV9IT1NULCBwb3J0PUFQSV9QT1JUKQo="

def patch():
    if not os.path.exists(SERVER_DIR):
        print(f"오류: 서버 디렉터리 없음: {SERVER_DIR}")
        sys.exit(1)

    os.makedirs(BACKUP_DIR, exist_ok=True)
    print(f"백업 디렉터리: {BACKUP_DIR}")
    for fname in ["models.py", "main.py"]:
        src = os.path.join(SERVER_DIR, fname)
        if os.path.exists(src):
            shutil.copy2(src, os.path.join(BACKUP_DIR, fname))
            print(f"  백업: {fname}")

    with open(os.path.join(SERVER_DIR, "models.py"), "wb") as f:
        f.write(base64.b64decode(MODELS_B64))
    print("✓ models.py 업데이트 완료")

    with open(os.path.join(SERVER_DIR, "main.py"), "wb") as f:
        f.write(base64.b64decode(MAIN_B64))
    print("✓ main.py 업데이트 완료")

    print()
    print("="*50)
    print("패치 완료! 서버를 재시작하세요:")
    print("  sudo systemctl restart wellcomsoft-api")
    print("="*50)

if __name__ == "__main__":
    patch()
